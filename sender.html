<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sender - Message Transfer App</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="firebase.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>ğŸ“¤ Sender</h2>
      <div class="card">Connected to project: <strong>thatha-4b729</strong></div>
    </div>

    <div class="card chat" id="chat"></div>

    <div class="card" style="margin-top:12px;">
      <div>
        <input id="text" type="text" placeholder="Type a message..." />
      </div>
      <div style="margin-top:8px;">
        <input id="file" type="file" accept="image/*" />
      </div>
      <div class="controls" style="margin-top:10px;">
        <button id="sendBtn">Send</button>
        <button id="refreshBtn" type="button">Refresh</button>
      </div>
      <small class="hint">This page identifies messages as <strong>Sender</strong>. Open <code>receiver.html</code> in another tab to reply.</small>
    </div>

    <div class="footer-note">Tip: If Firebase permissions block writes, ensure your Firestore rules allow read/write while testing.</div>
  </div>

<script>
const role = "Sender"; // label for messages sent from this page

const chatEl = document.getElementById('chat');
const textEl = document.getElementById('text');
const fileEl = document.getElementById('file');
const sendBtn = document.getElementById('sendBtn');
const refreshBtn = document.getElementById('refreshBtn');

// render message
function renderMessage(doc) {
  const data = doc.data();
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + ((data.sender === role) ? 'me' : 'them');
  const bubble = document.createElement('div');
  bubble.className = 'bubble card';
  const meta = document.createElement('div');
  meta.className = 'meta';
  const ts = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toLocaleString() : '';
  meta.textContent = (data.sender || 'Unknown') + ' â€¢ ' + ts;
  const text = document.createElement('div');
  text.textContent = data.text || '';
  bubble.appendChild(meta);
  bubble.appendChild(text);
  if (data.imageUrl) {
    const img = document.createElement('img');
    img.src = data.imageUrl;
    img.className = 'preview';
    bubble.appendChild(img);
  }
  wrapper.appendChild(bubble);
  chatEl.appendChild(wrapper);
}

// listen in real-time
const q = messagesRef.orderBy('timestamp');
q.onSnapshot(snapshot => {
  chatEl.innerHTML = '';
  snapshot.forEach(doc => renderMessage(doc));
  chatEl.scrollTop = chatEl.scrollHeight;
});

async function sendMessage() {
  const text = textEl.value.trim();
  const file = fileEl.files[0];
  let imageUrl = '';

  if (file) {
    const path = 'images/' + Date.now() + '_' + file.name;
    const storageRef = storage.ref(path);
    await storageRef.put(file);
    imageUrl = await storageRef.getDownloadURL();
  }

  await messagesRef.add({
    sender: role,
    text: text,
    imageUrl: imageUrl,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  textEl.value = '';
  fileEl.value = '';
}

sendBtn.addEventListener('click', sendMessage);
refreshBtn.addEventListener('click', () => {
  // force refresh by re-querying - but onSnapshot keeps it live
  messagesRef.orderBy('timestamp').get().then(snapshot => {
    chatEl.innerHTML = '';
    snapshot.forEach(doc => renderMessage(doc));
  });
});
</script>

</body>
</html>
